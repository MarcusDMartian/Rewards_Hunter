// ============================================
// PRISMA SCHEMA - Reward Hunter Database
// ============================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// ============================================
// CORE: Organizations, Teams, Users
// ============================================

model Organization {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  domain    String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users        User[]
  joinRequests JoinRequest[]
  teams        Team[]
}

model Team {
  id           String  @id @default(auto()) @map("_id") @db.ObjectId
  name         String
  parentTeamId String? @db.ObjectId
  orgId        String  @db.ObjectId

  parentTeam Team?  @relation("TeamHierarchy", fields: [parentTeamId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  childTeams Team[] @relation("TeamHierarchy")

  organization Organization @relation(fields: [orgId], references: [id])
  users        User[]

  @@unique([name, orgId])
}

model User {
  id              String  @id @default(auto()) @map("_id") @db.ObjectId
  email           String  @unique
  passwordHash    String
  name            String
  avatar          String  @default("")
  role            String  @default("Member")
  position        String  @default("Team Member")
  points          Int     @default(0)
  monthlyPoints   Int     @default(0)
  quarterlyPoints Int     @default(0)
  level           Int     @default(1)
  nextLevelPoints Int     @default(100)
  streak          Int     @default(0)
  lastActiveDate  String?
  isActive        Boolean @default(true)

  teamId String? @db.ObjectId
  orgId  String? @db.ObjectId

  team         Team?         @relation(fields: [teamId], references: [id])
  organization Organization? @relation(fields: [orgId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  kaizenIdeas        KaizenIdea[]
  kaizenVotes        KaizenVote[]
  kaizenComments     KaizenComment[]
  kaizenFollows      KaizenFollow[]
  kudosSent          Kudos[]              @relation("KudosSender")
  kudosReceived      Kudos[]              @relation("KudosReceiver")
  kudosLikes         KudosLike[]
  pointTransactions  PointTransaction[]
  redemptionRequests RedemptionRequest[]
  userBadges         UserBadge[]
  userMissions       UserMission[]
  feedbackIdentity   FeedbackIdentityMap[]
}

model JoinRequest {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  email        String
  name         String
  passwordHash String
  orgId        String   @db.ObjectId
  status       String   @default("PENDING")
  createdAt    DateTime @default(now())

  organization Organization @relation(fields: [orgId], references: [id])
}

// ============================================
// KAIZEN IDEAS
// ============================================

model KaizenIdea {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  title     String
  problem   String
  proposal  String
  impact    String
  status    String   @default("New")
  creatorId String   @db.ObjectId
  teamId    String?  @db.ObjectId
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  creator  User            @relation(fields: [creatorId], references: [id])
  votes    KaizenVote[]
  comments KaizenComment[]
  follows  KaizenFollow[]
}

model KaizenVote {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  ideaId    String   @db.ObjectId
  voterId   String   @db.ObjectId
  createdAt DateTime @default(now())

  idea  KaizenIdea @relation(fields: [ideaId], references: [id])
  voter User       @relation(fields: [voterId], references: [id])

  @@unique([ideaId, voterId])
}

model KaizenComment {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  ideaId    String   @db.ObjectId
  userId    String   @db.ObjectId
  text      String
  createdAt DateTime @default(now())

  idea KaizenIdea @relation(fields: [ideaId], references: [id])
  user User       @relation(fields: [userId], references: [id])
}

model KaizenFollow {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  ideaId    String   @db.ObjectId
  userId    String   @db.ObjectId
  createdAt DateTime @default(now())

  idea KaizenIdea @relation(fields: [ideaId], references: [id])
  user User       @relation(fields: [userId], references: [id])

  @@unique([ideaId, userId])
}

// ============================================
// KUDOS
// ============================================

model Kudos {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  senderId   String   @db.ObjectId
  receiverId String   @db.ObjectId
  coreValue  String
  message    String
  createdAt  DateTime @default(now())

  sender   User        @relation("KudosSender", fields: [senderId], references: [id])
  receiver User        @relation("KudosReceiver", fields: [receiverId], references: [id])
  likes    KudosLike[]
}

model KudosLike {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  kudosId   String   @db.ObjectId
  userId    String   @db.ObjectId
  createdAt DateTime @default(now())

  kudos Kudos @relation(fields: [kudosId], references: [id])
  user  User  @relation(fields: [userId], references: [id])

  @@unique([kudosId, userId])
}

// ============================================
// REWARDS & POINTS
// ============================================

model Reward {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  description String   @default("")
  image       String   @default("")
  cost        Int
  type        String
  stock       Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  redemptions RedemptionRequest[]
}

model PointTransaction {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  userId      String   @db.ObjectId
  amount      Int
  type        String
  source      String
  referenceId String?
  description String   @default("")
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}

model RedemptionRequest {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  userId      String    @db.ObjectId
  rewardId    String    @db.ObjectId
  rewardName  String
  pointsCost  Int
  status      String    @default("Pending")
  note        String?
  processedBy String?
  requestedAt DateTime  @default(now())
  processedAt DateTime?

  user   User   @relation(fields: [userId], references: [id])
  reward Reward @relation(fields: [rewardId], references: [id])
}

// ============================================
// GAMIFICATION
// ============================================

model Badge {
  id           String @id @default(auto()) @map("_id") @db.ObjectId
  name         String @unique
  icon         String @default("üèÜ")
  color        String @default("bg-indigo-100")
  description  String @default("")
  criteriaJson String @default("{}")

  userBadges UserBadge[]
}

model UserBadge {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  badgeId   String   @db.ObjectId
  awardedAt DateTime @default(now())
  reason    String   @default("")

  user  User  @relation(fields: [userId], references: [id])
  badge Badge @relation(fields: [badgeId], references: [id])

  @@unique([userId, badgeId])
}

model Mission {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  title        String
  description  String   @default("")
  type         String   @default("daily")
  triggerEvent String   @default("")
  targetCount  Int      @default(1)
  rewardPoints Int      @default(10)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  userMissions UserMission[]
}

model UserMission {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  userId      String   @db.ObjectId
  missionId   String   @db.ObjectId
  progress    Int      @default(0)
  completed   Boolean  @default(false)
  claimed     Boolean  @default(false)
  periodStart DateTime @default(now())
  periodEnd   DateTime
  updatedAt   DateTime @updatedAt

  user    User    @relation(fields: [userId], references: [id])
  mission Mission @relation(fields: [missionId], references: [id])

  @@unique([userId, missionId, periodStart])
}

// ============================================
// ANONYMOUS FEEDBACK
// ============================================

model FeedbackTemplate {
  id       String  @id @default(auto()) @map("_id") @db.ObjectId
  name     String
  type     String
  isActive Boolean @default(true)

  entries FeedbackEntry[]
}

model FeedbackEntry {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  templateId  String   @db.ObjectId
  targetType  String
  targetId    String?
  contentJson String   @default("{}")
  score       Int?
  createdAt   DateTime @default(now())

  template    FeedbackTemplate     @relation(fields: [templateId], references: [id])
  identityMap FeedbackIdentityMap?
}

model FeedbackIdentityMap {
  id         String @id @default(auto()) @map("_id") @db.ObjectId
  feedbackId String @unique @db.ObjectId
  userId     String @db.ObjectId

  feedback FeedbackEntry @relation(fields: [feedbackId], references: [id])
  user     User          @relation(fields: [userId], references: [id])
}
